# Multi-Tenant GitHub Dashboard - Cursor Rules

## Tech Stack
- **Frontend**: HTML, CSS, JavaScript (vanilla)
- **Backend**: Cloudflare Workers (Serverless)
- **Storage**: Cloudflare KV (Key-Value)
- **Hosting**: Vercel / Cloudflare Pages
- **Version Control**: GitHub

## Development Principles

### Critical Rules
1. **NEVER GUESS**: If uncertain about implementation details, requirements, or design decisions - ASK before proceeding
2. **Break up long tasks**: Split tasks taking more than 30 minutes into smaller sub-tasks
3. **Iterate and verify**: Complete each task fully before moving to the next; verify it works
4. **Security first**: This is a multi-tenant SaaS application - user data isolation is critical
5. **Clean code**: Modular, well-commented, consistent naming conventions
6. **Scalable**: Design for growth (more users, more repos, more data)
7. **Test before committing**: Run tests and check for console errors before committing

### Multi-Tenant Specific Rules
1. **User data isolation**: Every KV key MUST include userId to prevent cross-user access
2. **Token security**: Always encrypt GitHub tokens before storing in KV
3. **Session validation**: Validate user session on EVERY protected API endpoint
4. **No shared state**: Each user's data is completely isolated
5. **Audit trail**: Log authentication and data access events

### UI/UX Design Guidelines
- **User-centered design**: Keep end users at the center of every decision
- **Ease of use**: Organization, consistency, and intuitive navigation
- **Visual hierarchy**: Guide users through content with clear structure
- **Accessibility**: Ensure clickable actions are highly noticeable and accessible for color-blind users
- **Mobile-first**: Design for mobile screens first, then scale up
- **Loading states**: Always show loading indicators for async operations
- **Error handling**: Display user-friendly error messages, not technical jargon

## Reference Documentation

### UI/UX Design Resources (Consult Before Designing)
- Webflow UX Design Process: https://webflow.com/blog/ux-design-process
- Figma UI Design Principles: https://www.figma.com/resource-library/ui-design-principles/
- Figma Mobile Website Design: https://www.figma.com/resource-library/mobile-website-design/
- Figma Mobile-First Design: https://www.figma.com/resource-library/mobile-first-design/

### Technical Documentation (Consult Before Implementing)
- GitHub REST API: https://docs.github.com/en/rest
- GitHub OAuth: https://docs.github.com/en/apps/oauth-apps
- Cloudflare Workers: https://developers.cloudflare.com/workers/
- Cloudflare KV: https://developers.cloudflare.com/kv/
- Vercel Deployment: https://vercel.com/docs

### When to Use References
- **If unsure about GitHub API**: Consult GitHub docs before implementing
- **If unsure about Cloudflare Workers/KV**: Consult Cloudflare docs before implementing
- **If unsure about OAuth flow**: Review GitHub OAuth documentation
- **If unsure about UI/UX decisions**: Review Figma and Webflow resources before designing

## Code Style

### Naming Conventions
- **Files**: kebab-case (e.g., `repo-selector.js`)
- **Functions**: camelCase (e.g., `fetchUserRepos()`)
- **Constants**: UPPER_SNAKE_CASE (e.g., `SESSION_TTL`)
- **CSS Classes**: kebab-case (e.g., `.repo-card`)
- **KV Keys**: Structured with colons (e.g., `user:${userId}:repos`)

### Code Organization
- Keep functions small and focused (single responsibility)
- Use meaningful variable names (no single letters except loop counters)
- Add comments for complex logic and business rules
- Group related functions together
- Separate concerns: HTML (structure), CSS (presentation), JS (behavior)

### File Structure
```
template/
├── index.html              # Main dashboard
├── css/
│   ├── eoyr.css            # Dashboard-specific styles
│   └── *.css               # Base styles
├── js/
│   ├── auth.js             # Authentication module
│   ├── repo-selector.js    # Repository selection
│   ├── eoyr.js             # Core dashboard logic
│   └── eoyr-filters.js     # Filtering/sorting
└── workers/
    └── github-commits.js   # Cloudflare Worker API
```

## Project-Specific Implementation Notes

### Authentication Flow
- Use GitHub OAuth 2.0 for user authentication
- Store session tokens in HTTP-only, secure cookies
- Generate CSRF state tokens for OAuth flow
- Session TTL: 30 days (configurable)

### Data Storage (Cloudflare KV)
```javascript
// Key patterns - ALWAYS include userId
user:{userId}:token          // Encrypted GitHub access token
user:{userId}:profile        // User profile data
user:{userId}:repos          // Selected repositories
user:{userId}:preferences    // User settings
session:{sessionToken}       // Session -> userId mapping
cache:{userId}:{endpoint}    // User-scoped cached data
```

### API Endpoints Pattern
```javascript
// ALWAYS validate session first
async function protectedEndpoint(request, env) {
  const user = await getUserFromSession(request, env);
  if (!user) {
    return new Response('Unauthorized', { status: 401 });
  }
  
  // Use user.id for all data operations
  const data = await env.KV.get(`user:${user.id}:data`);
  // ... rest of logic
}
```

### GitHub API Integration
- Use user's personal GitHub token (obtained via OAuth)
- Respect GitHub rate limits (5000 req/hour per authenticated user)
- Cache responses to minimize API calls (TTL: 1 hour)
- Handle pagination for large datasets
- Check `X-RateLimit-Remaining` header

### Caching Strategy
- Cache user-scoped commit data with 1 hour TTL
- Include userId in all cache keys for isolation
- Invalidate cache on user action (e.g., repo selection change)
- Never cache sensitive data (tokens, passwords)

## Security Best Practices

### Token Management
- Encrypt GitHub tokens using Web Crypto API before storing
- Never expose tokens to frontend JavaScript
- Store encryption key in Worker environment variables
- Rotate session secrets periodically

### Session Security
- Use HTTP-only cookies (prevent XSS)
- Set Secure flag (HTTPS only)
- Set SameSite=Lax or Strict (CSRF protection)
- Validate session on every protected endpoint
- Clear session on logout

### Input Validation
- Validate all user inputs on backend
- Sanitize data before rendering in frontend
- Use parameterized queries (if using SQL in future)
- Limit request payload sizes

### CORS Configuration
- Only allow specific origins (not wildcard *)
- Include credentials only for trusted origins
- Validate Origin header on requests

## Error Handling

### Frontend
```javascript
try {
  const response = await fetch(API_URL);
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
  }
  const data = await response.json();
} catch (error) {
  console.error('Failed to fetch data:', error);
  showErrorMessage('Unable to load data. Please try again.');
}
```

### Backend (Worker)
```javascript
try {
  // ... operation
} catch (error) {
  console.error('Error:', error);
  return new Response(JSON.stringify({
    error: 'Internal server error',
    message: 'An unexpected error occurred'
  }), {
    status: 500,
    headers: { 'Content-Type': 'application/json' }
  });
}
```

## Performance Optimization

### Frontend
- Lazy load images and heavy components
- Debounce search inputs (300ms)
- Use event delegation for dynamic lists
- Minimize DOM manipulations
- Cache DOM queries

### Backend
- Cache API responses aggressively
- Use KV for session storage (faster than API calls)
- Minimize GitHub API calls with smart caching
- Batch operations where possible
- Return only necessary data fields

## Testing Strategy

### Manual Testing Checklist
- [ ] OAuth flow (login, callback, logout)
- [ ] Session persistence across page reloads
- [ ] Repository selection and saving
- [ ] Data displays correctly after login
- [ ] Filters work properly
- [ ] Date range selection
- [ ] Mobile responsiveness
- [ ] Error states display correctly
- [ ] No console errors
- [ ] CORS headers work correctly

### Browser Compatibility
- Chrome/Edge (latest)
- Firefox (latest)
- Safari (latest)
- Mobile Safari (iOS)
- Chrome Mobile (Android)

## Git Workflow

### Commit Messages
Follow conventional commits:
```
feat: Add repository selection UI
fix: Fix session expiration bug
docs: Update deployment guide
refactor: Simplify auth flow
style: Format CSS files
test: Add OAuth flow test
```

### Branch Strategy
- `main` - Production-ready code
- `develop` - Development branch
- `feature/*` - Feature branches
- `fix/*` - Bug fix branches

### Before Committing
1. Test locally
2. Check for console errors
3. Verify no secrets in code
4. Run linter if available
5. Update documentation if needed

## Common Pitfalls to Avoid

### ❌ Don't Do This
```javascript
// Shared state - NO!
let currentUser = null;

// Unencrypted token storage - NO!
await env.KV.put('token', githubToken);

// Missing user validation - NO!
async function getCommits(request, env) {
  return fetch(GITHUB_API);
}

// Wildcard CORS - NO!
headers.set('Access-Control-Allow-Origin', '*');
```

### ✅ Do This
```javascript
// Pass user context
async function processUser(userId, env) {
  // ...
}

// Encrypt tokens
await saveUserToken(env, userId, encryptToken(token));

// Always validate
async function getCommits(request, env) {
  const user = await getUserFromSession(request, env);
  if (!user) return unauthorized();
  // ...
}

// Specific CORS origin
headers.set('Access-Control-Allow-Origin', env.FRONTEND_URL);
```

## Deployment

### Pre-Deployment Checklist
- [ ] All environment variables set
- [ ] GitHub OAuth app configured
- [ ] KV namespace created and bound
- [ ] Test OAuth flow works
- [ ] Verify CORS configuration
- [ ] Check rate limiting
- [ ] Review security settings

### Environment Variables
**Required:**
- `GITHUB_OAUTH_CLIENT_ID`
- `GITHUB_OAUTH_CLIENT_SECRET`
- `SESSION_SECRET` (min 32 chars)
- `ENCRYPTION_KEY` (min 32 chars)

**Optional:**
- `SESSION_TTL` (default: 30 days)
- `CACHE_TTL` (default: 1 hour)
- `FRONTEND_URL` (for CORS)

## Documentation Standards

- Keep README.md up to date
- Document all API endpoints
- Add JSDoc comments for complex functions
- Update CHANGELOG.md for releases
- Include examples in documentation

## Getting Help

If stuck:
1. Check existing documentation (ARCHITECTURE.md, DEPLOYMENT.md)
2. Review Cloudflare Workers docs
3. Check GitHub API documentation
4. Ask for clarification - never guess!

---

**Remember**: This is a multi-tenant SaaS application. User data security and isolation are paramount. When in doubt, ask!
